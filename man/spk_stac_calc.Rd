% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/spk_stac_calc.R
\name{spk_stac_calc}
\alias{spk_stac_calc}
\title{Retrieve and optionally calculate spectral indices from a STAC item}
\usage{
spk_stac_calc(
  feature,
  aoi = NULL,
  asset_a = "red",
  asset_b = "nir08",
  asset_c = NULL,
  calc = "ndvi",
  vsi_prefix = "/vsicurl/",
  quiet = FALSE,
  timing = FALSE
)
}
\arguments{
\item{feature}{\link{list} A single STAC Item (one element from an \code{items$features}
list).}

\item{aoi}{\link[sf:sf]{sf::sf} or \link{NULL} Optional. An AOI object used to restrict reads (by
bbox) and to crop and mask the output. If \code{NULL}, the full assets are read and
no crop/mask is applied. Default is \code{NULL}.}

\item{asset_a}{\link{character} A single string giving the asset name for
the first (or only) input band. For NDVI this corresponds to the red band.
Default is \code{"red"}.}

\item{asset_b}{\link{character} or \link{NULL} Optional. A single string giving the asset
name for the second input band. For NDVI this corresponds to the NIR band.
For RGB this is the green band. Required when \code{calc} is not \code{NULL}. Default
is \code{"nir08"}.}

\item{asset_c}{\link{character} or \link{NULL} Optional. A single string giving the asset
name for the third input band. Required when \code{calc = "rgb"} (blue band).
Default is \code{NULL}.}

\item{calc}{\link{character} or \link{NULL} Optional. The calculation to perform:
\itemize{
\item \code{NULL}: No calculation; return \code{asset_a} only (optionally clipped).
\item \code{"ndvi"}: Normalized Difference Vegetation Index using
\code{(asset_b - asset_a) / (asset_b + asset_a)}.
\item \code{"rgb"}: Stack three bands into an RGB composite. Requires \code{asset_a}
(red), \code{asset_b} (green), and \code{asset_c} (blue).
}
Default is \code{"ndvi"}.}

\item{vsi_prefix}{\link{character} Optional. A single string giving the GDAL VSI
prefix used by \code{\link[terra:rast]{terra::rast()}} to enable streaming, windowed reads over HTTP.
Exposed to allow alternative VSI backends (e.g. \verb{/vsis3/}). Default is
\code{"/vsicurl/"}.}

\item{quiet}{\link{logical} Optional. If \code{TRUE}, suppress CLI messages. Default is
\code{FALSE}.}

\item{timing}{\link{logical} Optional. If \code{TRUE}, emit simple elapsed-time messages
for reads. Default is \code{FALSE}.}
}
\value{
A \link[terra:SpatRaster-class]{terra::SpatRaster} with asset values or calculated index values.
}
\description{
Retrieve raster assets from a single STAC item with optional clipping to an
AOI and optional spectral index calculation. When \code{calc = NULL}, the function
simply returns the first asset (\code{asset_a}), optionally clipped. When \code{calc}
specifies an index (e.g., \code{"ndvi"}), the function reads the required assets
and computes the index.
}
\details{
The default asset names (\code{"red"} and \code{"nir08"}) align with common conventions
in Landsat Collection 2 Level-2 STAC items (e.g. the \code{landsat-c2-l2} collection
on Planetary Computer), but are fully parameterized to support other
collections with different band naming schemes.

This function expects \code{feature} to provide the required \code{assets} referenced by
\code{asset_a} and, when \code{calc} is not \code{NULL}, also \code{asset_b} (and \code{asset_c} for
RGB). When \code{aoi} is not \code{NULL}, \code{feature} must also have
\code{properties$"proj:epsg"} so the AOI can be transformed for windowed reads.

When \code{calc = NULL}, only \code{asset_a} is read and returned (optionally clipped
to the AOI). When \code{calc = "ndvi"}, the function computes the Normalized
Difference Vegetation Index using \code{(b - a) / (b + a)}. When \code{calc = "rgb"},
the three assets are stacked into an RGB composite at native resolution.
This structure allows additional spectral indices (e.g. NDWI, EVI) to be added
in the future without changing the data access or cropping logic.

When \code{aoi} is provided, reading is limited to the AOI bounding box in the
feature's projected CRS, and then cropped/masked to the AOI. When \code{aoi = NULL},
the full assets are read and returned for the full raster extent.
}
\section{Production-ready alternative}{

This function is a proof of concept demonstrating how to perform raster
calculations on STAC items using \code{terra}. For production workflows involving
time series reductions, multi-image composites, or data cubes with varying
pixel sizes and coordinate reference systems, consider the
\href{https://github.com/appelmar/gdalcubes}{gdalcubes} package. Key functions
include:
\itemize{
\item \code{stac_image_collection()}: Create an image collection directly from
STAC query results with automatic band detection and VSI prefix handling.
\item \code{cube_view()}: Define spatiotemporal extent, resolution, aggregation,
and resampling method in a single specification.
\item \code{raster_cube()}: Build a data cube from an image collection,
automatically reprojecting and resampling images to a common grid.
\item \code{apply_pixel()}: Apply arithmetic expressions (e.g.,
\code{"(nir - red) / (nir + red)"}) across all pixels.
\item \code{reduce_time()}: Temporal reductions (mean, median, max, etc.) to
composite multi-date imagery.
}
}

\examples{
\dontrun{
# STAC query against Planetary Computer (Landsat C2 L2)
stac_url <- "https://planetarycomputer.microsoft.com/api/stac/v1"
y <- 2000
date_time <- paste0(y, "-05-01/", y, "-07-30")

# Define an AOI from a bounding box (WGS84)
bbox <- c(
  xmin = -126.55350240037997,
  ymin =  54.4430453753869,
  xmax = -126.52422763064457,
  ymax =  54.46001902038006
)

aoi <- sf::st_as_sfc(sf::st_bbox(bbox, crs = 4326)) |>
  sf::st_as_sf()

stac_query <- rstac::stac(stac_url) |>
  rstac::stac_search(
    collections = "landsat-c2-l2",
    datetime = date_time,
    intersects = sf::st_geometry(aoi)[[1]],
    limit = 200
  ) |>
  rstac::ext_filter(`eo:cloud_cover` <= 10)

items <- stac_query |>
  rstac::post_request() |>
  rstac::items_fetch() |>
  rstac::items_sign_planetary_computer()

ndvi_list <- items$features |>
  purrr::map(spk_stac_calc, aoi = aoi)

ndvi_list <- ndvi_list |>
  purrr::set_names(purrr::map_chr(items$features, "id"))

# Retrieve a single asset (no calculation) from Sentinel-2
stac_query_s2 <- rstac::stac(stac_url) |>
  rstac::stac_search(
    collections = "sentinel-2-l2a",
    datetime = "2023-07-01/2023-07-31",
    intersects = sf::st_geometry(aoi)[[1]],
    limit = 10
  ) |>
  rstac::ext_filter(`eo:cloud_cover` <= 10)

items_s2 <- stac_query_s2 |>
  rstac::post_request() |>
  rstac::items_fetch() |>
  rstac::items_sign_planetary_computer()

# Get just the visual (RGB) asset clipped to AOI, no calculation
visual_list <- items_s2$features |>
  purrr::map(spk_stac_calc, aoi = aoi, asset_a = "visual", calc = NULL)

# Build RGB composite from native 10m bands (higher resolution than visual)
rgb_list <- items_s2$features |>
  purrr::map(
    spk_stac_calc,
    aoi = aoi,
    asset_a = "B04",
    asset_b = "B03",
    asset_c = "B02",
    calc = "rgb"
  )
}
}
\seealso{
\code{\link[terra:rast]{terra::rast()}}, \code{\link[terra:crop]{terra::crop()}}, \code{\link[terra:mask]{terra::mask()}}, \code{\link[sf:st_transform]{sf::st_transform()}}

Other spacehakr: 
\code{\link{spk_gdalwarp}()},
\code{\link{spk_join}()},
\code{\link{spk_layer_info}()},
\code{\link{spk_odm}()},
\code{\link{spk_poly_to_points}()},
\code{\link{spk_q_layer_info}()},
\code{\link{spk_rast_ext}()},
\code{\link{spk_rast_not_empty}()},
\code{\link{spk_rast_rm_empty}()},
\code{\link{spk_res}()}
}
\concept{spacehakr}
