# spacehakr

R package for spatial analysis, raster processing, and geospatial data
access. Extracted from the `ngr_spk_*` function family in the
[ngr](https://github.com/NewGraphEnvironment/ngr) package.

## Repository Context

**Repository:** NewGraphEnvironment/spacehakr **Primary Language:** R
**License:** MIT **URL:**
<http://www.newgraphenvironment.com/spacehakr/>

## Migration from ngr

Functions are renamed from `ngr_spk_*` to `spk_*`:

| ngr (source)               | spacehakr (target)     | Purpose                                        |
|----------------------------|------------------------|------------------------------------------------|
| `ngr_spk_gdalwarp()`       | `spk_gdalwarp()`       | GDALWarp command argument builder              |
| `ngr_spk_geoserv_dlv()`    | `spk_geoserv_dlv()`    | Download vector from GeoServer WFS             |
| `ngr_spk_join()`           | `spk_join()`           | Spatial join with optional mask filtering      |
| `ngr_spk_layer_info()`     | `spk_layer_info()`     | Summarise layers/geometry types in data source |
| `ngr_spk_odm()`            | `spk_odm()`            | Docker command builder for OpenDroneMap        |
| `ngr_spk_poly_to_points()` | `spk_poly_to_points()` | Generate regular points inside polygons        |
| `ngr_spk_q_layer_info()`   | `spk_q_layer_info()`   | Extract layer info from QGIS project           |
| `ngr_spk_rast_ext()`       | `spk_rast_ext()`       | Combined extent from multiple rasters          |
| `ngr_spk_rast_not_empty()` | `spk_rast_not_empty()` | Check if raster has non-zero data              |
| `ngr_spk_rast_rm_empty()`  | `spk_rast_rm_empty()`  | Remove empty raster files                      |
| `ngr_spk_res()`            | `spk_res()`            | Extract raster resolution                      |
| `ngr_spk_stac_calc()`      | `spk_stac_calc()`      | Retrieve/calculate spectral indices from STAC  |

Tests transfer with the same rename pattern.

## Build & Test Commands

``` r
devtools::document()
devtools::test()                    # Use this for development - faster
devtools::check(vignettes = FALSE)  # Only when needed; always skip vignettes
lintr::lint_package()               # Run before committing
devtools::install()
```

- Prefer `devtools::test()` during development - it’s faster
- Only run `devtools::check()` when preparing for release or CI
- Always skip vignettes during checks (`vignettes = FALSE`)

## Function Naming

All exported functions use prefix `spk_`: - `spk_rast_*` - Raster
operations - `spk_gdalwarp()`, `spk_odm()` - External tool command
builders - `spk_geoserv_*`, `spk_stac_*` - Remote data access -
`spk_join()`, `spk_poly_to_points()`, `spk_layer_info()` -
Vector/spatial operations

## Architecture

    R/                  # Function source files, one function per file
    tests/testthat/     # testthat tests, one test file per function
    man/                # Generated by roxygen2 (never edit manually)
    vignettes/          # Long-form documentation
    data-raw/           # Scripts for generating package data (hex sticker, etc.)
    dev/                # Development scripts (not in package)

## Key Dependencies

- **sf** - Vector spatial data (simple features)
- **terra** - Raster operations
- **chk** - Argument validation (`chk_string()`, `chk_flag()`, etc.)
- **cli** - User messaging (`cli_abort()`, `cli_alert_success()`)
- **dplyr/purrr/stringr** - Data wrangling
- **fs** - File system operations
- **glue** - String interpolation
- **httr/curl** - HTTP requests
- **xml2** - XML parsing (QGIS project files)

Vignette-only packages go in Suggests (e.g., rstac, leaflet, mapview).

## Documentation Style

- Roxygen2 with markdown enabled (`Roxygen: list(markdown = TRUE)`)
- `@family spacehakr` tag on all exported functions
- `@importFrom` for all external functions (explicit, never `@import`)
- `@examples` with `\dontrun{}` for slow/network examples
- `@seealso` for related functions

## Code Quality Standards

### lintr

Use lintr for static analysis. Follow the default tidyverse style
with: - Line length max 120 characters - snake_case for all names - No
assignment with `=` (use `<-`)

### DRY (Don’t Repeat Yourself)

- Extract shared logic into internal helpers (not exported, no
  `@export`)
- Name internal helpers with a leading dot or descriptive name without
  `spk_` prefix
- If the same pattern appears 3+ times, factor it out

### YAGNI (You Aren’t Gonna Need It)

- Don’t add parameters “just in case”
- Don’t write generalized versions of specific functions
- If a feature isn’t needed now, don’t build it
- Default parameter values should cover 90% of use cases

### KISS (Keep It Simple)

- One function per file, named to match (`spk_join.R` contains
  `spk_join()`)
- Flat control flow preferred over deeply nested logic
- Early returns for guard clauses
- Pipe chains (`|>`) for data transformation, not for side effects

### Defensive Programming

- Validate all user-facing inputs with `chk` at function entry
- Use
  [`cli::cli_abort()`](https://cli.r-lib.org/reference/cli_abort.html)
  for errors with informative messages
- Never silently swallow errors or warnings
- Document expected types in `@param`

## Commit Style (fledge)

This repo uses [fledge](https://github.com/cynkra/fledge) for changelog
management.

**NEWS-worthy commits** start with `-` (bullet point):

    - initial commit of [spk_join()] to close [#1](https://github.com/NewGraphEnvironment/spacehakr/issues/1)

**Function references** use square brackets for pkgdown auto-links:
`[spk_join()]`

**Issue references** use full markdown links:
`[#1](https://github.com/NewGraphEnvironment/spacehakr/issues/1)`

**Non-NEWS commits** (docs, chores) don’t start with `-`:

    rebuild documentation and update build config

## DESCRIPTION Management

- Keep Imports alphabetized
- Don’t duplicate packages in both Imports and Suggests
- Add vignette-only packages to Suggests

## Hex Sticker

Generate with `data-raw/make_hexsticker.R` using the hexSticker package.
Black background, white NG icon, white “spacehakr” text, Helvetica font.

## GitHub CLI (gh) Idiosyncrasies

- **Use backticks for function names in issue titles**:
  `` gh issue create --title "Add \`spk_join()\`" ``
- **No `gh milestone` command** - use `gh api` for milestones
- **`--milestone` flag needs title, not number**

------------------------------------------------------------------------

# LLM Behavioral Guidelines

Reduce common LLM coding mistakes. Bias toward caution over speed. For
trivial tasks, use judgment.

## 1. Think Before Coding

**Don’t assume. Don’t hide confusion. Surface tradeoffs.**

Before implementing: - State your assumptions explicitly. If uncertain,
ask. - If multiple interpretations exist, present them - don’t pick
silently. - If a simpler approach exists, say so. Push back when
warranted. - If something is unclear, stop. Name what’s confusing. Ask.

## 2. Simplicity First

**Minimum code that solves the problem. Nothing speculative.**

- No features beyond what was asked.
- No abstractions for single-use code.
- No “flexibility” or “configurability” that wasn’t requested.
- No error handling for impossible scenarios.
- If you write 200 lines and it could be 50, rewrite it.

Ask yourself: “Would a senior engineer say this is overcomplicated?” If
yes, simplify.

## 3. Surgical Changes

**Touch only what you must. Clean up only your own mess.**

When editing existing code: - Don’t “improve” adjacent code, comments,
or formatting. - Don’t refactor things that aren’t broken. - Match
existing style, even if you’d do it differently. - If you notice
unrelated dead code, mention it - don’t delete it.

When your changes create orphans: - Remove imports/variables/functions
that YOUR changes made unused. - Don’t remove pre-existing dead code
unless asked.

The test: Every changed line should trace directly to the user’s
request.

## 4. Goal-Driven Execution

**Define success criteria. Loop until verified.**

Transform tasks into verifiable goals: - “Add validation” -\> “Write
tests for invalid inputs, then make them pass” - “Fix the bug” -\>
“Write a test that reproduces it, then make it pass” - “Refactor X” -\>
“Ensure tests pass before and after”

For multi-step tasks, state a brief plan:

    1. [Step] -> verify: [check]
    2. [Step] -> verify: [check]
    3. [Step] -> verify: [check]

------------------------------------------------------------------------

**These guidelines are working if:** fewer unnecessary changes in diffs,
fewer rewrites due to overcomplication, and clarifying questions come
before implementation rather than after mistakes.

# NewGraph Environment Conventions

Core patterns for professional, efficient workflows across NewGraph
repositories.

## Issue Creation Guidelines

### Professional Issue Writing

Write issues with clear technical focus:

- **Use normal technical language** in titles and descriptions
- **Focus on the problem and solution** approach
- **Avoid internal project codes or tracking references** in the main
  description
- **Add tracking links at the end** if needed (e.g.,
  `Relates to Owner/repo#N`)

**Why:** Issues are read by consultants, clients, and collaborators.
Keep them professional and focused on technical content.

### GitHub Issue Creation - Always Use Files

The `gh issue create` command with heredoc syntax fails repeatedly with
EOF errors. ALWAYS use intermediate file approach:

``` bash
# Write issue body to scratchpad file first
cat > /path/to/scratchpad/issue_body.md << 'EOF'
## Problem
...

## Proposed Solution
...
EOF

# Then create issue from file
gh issue create --title "Brief technical title" --body-file /path/to/scratchpad/issue_body.md
```

## Commit Quality

Write clear, informative commit messages:

    Brief description (50 chars or less)

    Detailed explanation of changes and impact.
    - What changed
    - Why it changed
    - Relevant context

    Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>

**When to commit:** - Logical, atomic units of work - Working state
(tests pass) - Clear description of changes

**What to avoid:** - “WIP” or “temp” commits in main branch - Combining
unrelated changes - Vague messages like “fixes” or “updates”
